---
title: 'Stat 331 - Final'
author: "Lillie Allen, Nick Bukovec, Nikhil Koganti, Madeline Willett"
date: "3/2/2022"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, 
  warning = FALSE, 
  fig.align = "center"
  )

```

```{r libs}
library(tidyverse)
library(prettydoc)
library(here)
library(broom)
```

```{r formatting, include = FALSE}
# Center all plot titles
theme_update(plot.title = element_text(hjust = 0.5))
```

# Load Data
```{r load}
oil <- read_csv(here::here("oil_consumption_per_cap.csv"))
sdi <- read_csv(here::here("sdi.csv"))
```

# Clean Data

```{r clean}
oil_clean <- oil %>%
  # Coerce types
  transmute(
    country = as.factor(country),
    across(`1965`:`2019`, as.numeric)
    ) %>% 
  # Pivot 
  pivot_longer(
    cols = `1965`:`2019`, 
    names_to = "year",
    values_to = "Oil Consumption per Person (tonnes/person)",
    )

sdi_clean <- sdi %>% 
  # Coerce types
  transmute(
    country = as.factor(country),
    across(`1990`:`2019`, as.numeric)
    ) %>% 
  # Pivot
  pivot_longer(
    cols = `1990`:`2019`, 
    names_to = "year",
    values_to = "Sustainable Development Index",
    ) 

dataset <- sdi_clean %>% 
  # Join data by year and country
  inner_join(oil_clean, by = c("year", "country")) %>% 
  # Drop any missing data
  drop_na()
```

# Data Visualization

```{r}
dataset %>%
  ggplot(mapping = aes(
    x = `Oil Consumption per Person (tonnes/person)`, 
    y = `Sustainable Development Index`)) +
    geom_point() +
    geom_smooth(method = "lm") +
  labs(
    title = "Relationship Between Oil Consumption per Person and SDI",
    x = "Oil Consumption per Person (tonnes/person)",
    y = "Sustainable Development Index"
  )
```
 
# Visualization Over Time

```{r}
dataset %>%
  group_by(year) %>%
  mutate(ratio = (`Sustainable Development Index`/`Oil Consumption per Person (tonnes/person)`)) %>%
  summarize(mean = mean(ratio)) %>%
  ggplot(mapping = aes(
    x = `year`, 
    y = mean)) +
  geom_point() + 
  labs(
    title = "Mean Ratio of SDI to Oil Consumption Per Person Over Time",
    x = "Year",
    y = "Mean Ratio"
  ) +
  theme(axis.text.x = element_text(size = 7))
```

# Linear Regression

```{r}
dataset_lm <- dataset %>%
  lm(`Sustainable Development Index` ~ `Oil Consumption per Person (tonnes/person)`, data = .)
```

```{r}
broom::glance(dataset_lm) 
```
SDI = 67.32 -7.714(Oil Consumption)
The intercept, b0 = 67.32, is the average Sustainable Development Index y = SDI for those countries where the average Oil Consumption per Person is 0. It has no practical interpretation here, since observing an SDI of 0 is impossible. The slope for Oil Consumption per Person, b1 = -7.714,
summarizes the relationship between the SDI and Oil Consumption per Person variables. The sign is negative, suggesting a negative relationship between these two variables, meaning countries with higher average Oil Consumption per Person tend to have lower Sustainable Development Indexes. For every increase of 1 unit in Oil Consumption per Person, there is an associated decrease of, on average, 7.714 units of SDI.

```{r}
lm_tibble <- broom::augment(dataset_lm) %>% 
  summarise('Response Variance' = var(`Sustainable Development Index`),
            'Fitted Value Variance' = var(.fitted),
            'Residual Variance' = var(.resid)) %>% 
  mutate('Proportion of Variance Accounted for in Model' = `Fitted Value Variance` / (`Response Variance` + `Fitted Value Variance` + `Residual Variance`))
```

```{r}
lm_tibble %>%
  kbl() %>%
  kable_styling()
```

# Discussion
The variance in the response variable, 374.7564, tells us how much Countries differ in Sustainable Development Index. The variance in the fitted values, 150.5912, from our regression model tells us how much the fitted values from our linear regression model vary. The variance of the residuals, 224.1652, tells us how much “the left-overs” from the model vary. The proportion of the variability in the response values that was accounted for by our regression model is 0.2009188; thus, our linear regression model explains about 20% of the variation in Sustainable Development Index. This suggests that our model does not tell us everything we need to know about Sustainable Development Index.


```{r}
predict_sdi <- predict(dataset_lm)
```


```{r}
oil_sigma <- sigma(dataset_lm)

noise <- function(predicted_vals, mean = 0, sd){
  predicted_vals + rnorm(length(predicted_vals),
            mean,
            sd)
}

expected_data <- tibble(predicted_values = noise(predict_sdi, 
                                          sd = oil_sigma
                                          )
                   )
```

```{r}
expected_data <- dataset %>% 
  filter(!is.na(`Oil Consumption per Person (tonnes/person)`), 
         !is.na(`Sustainable Development Index`)
         ) %>% 
  select(`Oil Consumption per Person (tonnes/person)`, `Sustainable Development Index`) %>% 
  bind_cols(expected_data)
```


```{r}
pred <- expected_data %>% 
  ggplot(aes(x = `Oil Consumption per Person (tonnes/person)`,
             y = predicted_values)) +
  geom_point() +
  labs(x = "Oil Consumption (tonnes/person)",
       y = "Simulated SDI")

obs <- dataset %>% 
  ggplot(aes(x = `Oil Consumption per Person (tonnes/person)`,
             y = `Sustainable Development Index`)) + 
  geom_point() + 
  labs(x = "Oil Consumption (tonnes/person)",
       y = "Observed SDI")


gridExtra::grid.arrange(pred, obs, nrow = 1)
```

```{r}
expected_data %>%
  lm(`Sustainable Development Index` ~ predicted_values, data = .) %>%
  glance() %>%
  select(r.squared) %>%
  pull()
```


The observed data appears to be more extreme than the simulated data. It also seems to be scattered a lot more than the simulated data. The r squared value of the simulated data is 17% which is less than the 20% for the observed data. Thus, our linear model explains less simulated SDI variance compared to the observed SDI variance. 
